<!--
  Shared Ledger Table Component Template
  Material Design Enhanced - Compact Layout with Inline Add
-->
<div class="table-container">
  <!-- Add Button -->
  <div class="table-toolbar" *ngIf="editable">
    <button mat-raised-button 
            color="primary" 
            (click)="addNewRow()" 
            [disabled]="isAddingNew"
            class="add-row-btn">
      <mat-icon>add</mat-icon>
      Thêm dòng
    </button>
  </div>

  <table class="ledger-table mat-elevation-z1">
    <!-- Multi-level Header -->
    <thead>
      <!-- Header Row 1 (Main groups) -->
      <tr *ngIf="headerRows.length > 0" class="header-row-1">
        <ng-container *ngFor="let col of headerRows[0]">
          <th [attr.rowspan]="col.rowspan || 1"
              [attr.colspan]="col.colspan || 1"
              [class]="'mat-header-cell ' + (col.class || '')"
              [style.width]="col.width || 'auto'">
            {{ col.label }}
          </th>
        </ng-container>
        <th [attr.rowspan]="showColumnLabels ? headerRows.length + 1 : headerRows.length" 
            class="mat-header-cell action-col" 
            *ngIf="editable">Thao tác</th>
      </tr>
      <!-- Header Row 2 (Sub groups) -->
      <tr *ngIf="headerRows.length > 1" class="header-row-2">
        <ng-container *ngFor="let col of headerRows[1]">
          <th [attr.rowspan]="col.rowspan || 1"
              [attr.colspan]="col.colspan || 1"
              [class]="'mat-header-cell ' + (col.class || '')">
            {{ col.label }}
          </th>
        </ng-container>
      </tr>
      <!-- Header Row 3 (Column labels A, B, C...) -->
      <tr *ngIf="showColumnLabels" class="header-row-labels">
        <ng-container *ngFor="let col of columnLabels">
          <th class="mat-header-cell col-label">{{ col }}</th>
        </ng-container>
      </tr>
    </thead>

    <!-- Body -->
    <tbody>
      <!-- New Row (Adding mode) -->
      <tr *ngIf="isAddingNew && newRow" class="data-row adding-row">
        <ng-container *ngFor="let col of dataColumns">
          <td [class]="'mat-cell ' + getCellClass(col)">
            <!-- Text input (nested key) -->
            <input *ngIf="col.type === 'text' && col.nestedKey"
                   type="text"
                   [ngModel]="getNestedValue(newRow, col.key, col.nestedKey)"
                   (ngModelChange)="setNestedValue(newRow, col.key, col.nestedKey, $event)"
                   class="compact-input"
                   [placeholder]="col.nestedKey === 'soHieu' ? 'Số hiệu (bắt buộc)' : ''" />

            <!-- Text input (simple key) -->
            <input *ngIf="col.type === 'text' && !col.nestedKey"
                   type="text"
                   [(ngModel)]="newRow[col.key]"
                   class="compact-input"
                   placeholder="" />

            <!-- Number input (nested key) -->
            <input *ngIf="col.type === 'number' && col.nestedKey"
                   type="number"
                   [ngModel]="getNestedValue(newRow, col.key, col.nestedKey)"
                   (ngModelChange)="setNestedValue(newRow, col.key, col.nestedKey, $event)"
                   class="compact-input number-input"
                   placeholder="0" />

            <!-- Number input (simple key) -->
            <input *ngIf="col.type === 'number' && !col.nestedKey"
                   type="number"
                   [(ngModel)]="newRow[col.key]"
                   class="compact-input number-input"
                   placeholder="0" />

            <!-- Date input -->
            <input *ngIf="col.type === 'date'"
                   type="date"
                   [value]="getDateInputValue(col.nestedKey ? getNestedValue(newRow, col.key, col.nestedKey) : newRow[col.key])"
                   (change)="col.nestedKey ? setNestedValue(newRow, col.key, col.nestedKey, ($any($event.target)).value) : onDateChange($event, newRow, col.key)"
                   class="compact-input date-input" />
          </td>
        </ng-container>

        <!-- Actions for new row -->
        <td class="mat-cell action-col" *ngIf="editable">
          <div class="action-buttons">
            <button mat-icon-button 
                    color="primary" 
                    matTooltip="Lưu"
                    (click)="saveNewRow()"
                    class="action-btn-icon">
              <mat-icon>check</mat-icon>
            </button>
            <button mat-icon-button 
                    matTooltip="Hủy"
                    (click)="cancelNewRow()"
                    class="action-btn-icon">
              <mat-icon>close</mat-icon>
            </button>
          </div>
        </td>
      </tr>

      <!-- Existing Data Rows -->
      <tr *ngFor="let row of data; let i = index"
          [class.editing]="editingId === row.id"
          class="data-row">
        <!-- Data Columns -->
        <ng-container *ngFor="let col of dataColumns">
          <td [class]="'mat-cell ' + getCellClass(col)">
            <!-- Display mode -->
            <ng-container *ngIf="editingId !== row.id">
              <!-- Non-number display -->
              <span *ngIf="col.type !== 'number'">
                {{ getCellDisplay(row, col) }}
              </span>
              <!-- Number with dynamic font size -->
              <span *ngIf="col.type === 'number'" 
                    class="number-value"
                    [style.fontSize]="getNumberFontSize(getNestedValue(row, col.key, col.nestedKey))">
                {{ getCellDisplay(row, col) }}
              </span>
            </ng-container>

            <!-- Edit mode -->
            <ng-container *ngIf="editingId === row.id && editable">
              <!-- Text input (nested key) -->
              <input *ngIf="col.type === 'text' && col.nestedKey"
                     type="text"
                     [ngModel]="getNestedValue(row, col.key, col.nestedKey)"
                     (ngModelChange)="setNestedValue(row, col.key, col.nestedKey, $event)"
                     [readonly]="col.readonly"
                     class="compact-input" />

              <!-- Text input (simple key) -->
              <input *ngIf="col.type === 'text' && !col.nestedKey"
                     type="text"
                     [(ngModel)]="row[col.key]"
                     [readonly]="col.readonly"
                     class="compact-input" />

              <!-- Number input (nested key) -->
              <input *ngIf="col.type === 'number' && col.nestedKey"
                     type="number"
                     [ngModel]="getNestedValue(row, col.key, col.nestedKey)"
                     (ngModelChange)="setNestedValue(row, col.key, col.nestedKey, $event)"
                     [readonly]="col.readonly"
                     class="compact-input number-input" />

              <!-- Number input (simple key) -->
              <input *ngIf="col.type === 'number' && !col.nestedKey"
                     type="number"
                     [(ngModel)]="row[col.key]"
                     [readonly]="col.readonly"
                     class="compact-input number-input"
                     (ngModelChange)="onNumberChange(row, col)" />

              <!-- Date input -->
              <input *ngIf="col.type === 'date'"
                     type="date"
                     [value]="getDateInputValue(col.nestedKey ? getNestedValue(row, col.key, col.nestedKey) : row[col.key])"
                     (change)="col.nestedKey ? setNestedValue(row, col.key, col.nestedKey, ($any($event.target)).value) : onDateChange($event, row, col.key)"
                     class="compact-input date-input" />
            </ng-container>
          </td>
        </ng-container>

        <!-- Actions -->
        <td class="mat-cell action-col" *ngIf="editable">
          <div class="action-buttons">
            <ng-container *ngIf="editingId !== row.id">
              <button mat-icon-button 
                      color="primary" 
                      matTooltip="Sửa"
                      (click)="startEdit(row)"
                      [disabled]="isAddingNew"
                      class="action-btn-icon">
                <mat-icon>edit</mat-icon>
              </button>
              <button mat-icon-button 
                      color="warn" 
                      matTooltip="Xóa"
                      (click)="deleteRow(row.id)"
                      [disabled]="isAddingNew"
                      class="action-btn-icon">
                <mat-icon>delete</mat-icon>
              </button>
            </ng-container>
            <ng-container *ngIf="editingId === row.id">
              <button mat-icon-button 
                      color="primary" 
                      matTooltip="Lưu"
                      (click)="saveEdit(row)"
                      class="action-btn-icon">
                <mat-icon>check</mat-icon>
              </button>
              <button mat-icon-button 
                      matTooltip="Hủy"
                      (click)="cancelEdit()"
                      class="action-btn-icon">
                <mat-icon>close</mat-icon>
              </button>
            </ng-container>
          </div>
        </td>
      </tr>

      <!-- Empty state -->
      <tr *ngIf="data.length === 0 && !isAddingNew" class="empty-row">
        <td [attr.colspan]="dataColumns.length + (editable ? 1 : 0)" class="empty-cell">
          <mat-icon class="empty-icon">inbox</mat-icon>
          <span>Chưa có dữ liệu. Nhấn "Thêm dòng" để bắt đầu.</span>
        </td>
      </tr>
    </tbody>

    <!-- Footer rows -->
    <tfoot *ngIf="footerRows.length > 0">
      <tr *ngFor="let footer of footerRows" [class]="'footer-row ' + (footer.class || '')">
        <td [attr.colspan]="footer.labelColspan || 1" class="mat-footer-cell footer-label">
          {{ footer.label }}
        </td>
        <ng-container *ngFor="let val of footer.values">
          <td class="mat-footer-cell number-value" [style.fontSize]="getNumberFontSize(val)">
            {{ formatNumber(val) }}
          </td>
        </ng-container>
        <td *ngIf="footer.noteColspan" [attr.colspan]="footer.noteColspan" class="mat-footer-cell"></td>
        <td *ngIf="editable" class="mat-footer-cell action-col"></td>
      </tr>
    </tfoot>
  </table>
</div>
